!function(t){"use strict";var s,i=Array.prototype.push,e=t.Transport,n=t.TransportEvent,o=(t.util,{OK:"OK"}),r={PING:"/PING",PONG:"/PONG",STATUS:"/STATUS"};function a(t){var s;e.call(this,t),this._options=t,this._client=null,this._timer=null,this._sendTimer=null,this._buf=[],this._status="",this._connHandler=function(){window.addEventListener("message",this._messageHandler,!1),this.isOpen=!0}.bind(this),this._messageHandler=function(t){var s=t.data;if(t.origin!==location.origin)return;if(!s.transport)return;var i=s.destinationName,e=this._status;if(-1===[this._options.device+r.PONG,this._options.device+r.STATUS].indexOf(i))return;switch(i.substr(i.lastIndexOf("/")+1)){case"STATUS":this._status=s.payloadString,function(t,s,i){if(s===i)return;s===o.OK?t.emit(n.OPEN):t.emit(n.ERROR,new Error("board connection failed."))}(this,this._status,e);break;default:this._status===o.OK&&this.emit(n.MESSAGE,s.payloadBytes)}}.bind(this),this._sendOutHandler=function(){this.isOpen&&this._window.postMessage({transport:!0,destinationName:this._options.device+r.PING,payloadBytes:new Uint8Array(this._buf)},location.origin);t=this,t._buf=[],clearImmediate(t._sendTimer),t._sendTimer=null;var t}.bind(this),(s=this)._window=s._options.window||window,s._window.postMessage({transport:!0,transportReady:!0},location.origin),window.addEventListener("message",function t(i){var e=i.data;i.origin===location.origin&&e.transport&&(i.source===s._window?e.transportReady&&(i.source.postMessage({transport:!0,transportGo:!0},location.origin),window.removeEventListener("message",t),s._connHandler()):console.error("message transport 接收訊息有問題"))})}a.prototype=s=Object.create(e.prototype,{constructor:{value:a},isOpen:{get:function(){return this._isOpen},set:function(t){this._isOpen=t}}}),s.send=function(t){this._buf.length+t.length+this._options.device.length+r.PING.length+4>a.MAX_PACKET_SIZE&&this._sendOutHandler(),i.apply(this._buf,t),this._sendTimer||(this._sendTimer=setImmediate(this._sendOutHandler))},s.close=function(){window.removeEventListener("message",this._messageHandler),delete this._window,delete this._options,this.isOpen=!1},s.flush=function(){this._buf&&this._buf.length&&this._sendOutHandler()},t.transport.message=a}(webduino);